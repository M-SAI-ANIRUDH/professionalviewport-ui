name: CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package.json

      - name: Install dependencies
        run: npm ci || npm install

      - name: Build
        run: npm run build --if-present
      - name: Prepare publish directory (combine browser + server)
        run: |
          # Browser and Server outputs are created by the Angular build when SSR is enabled
          PWD_DIST=dist/professional-viewport-ui
          PUB=dist_publish
          rm -rf "$PUB"
          mkdir -p "$PUB"
          # copy browser (static site) into publish root
          if [ -d "$PWD_DIST/browser" ]; then
            cp -r "$PWD_DIST/browser"/* "$PUB/"
          elif [ -d "$PWD_DIST" ]; then
            # fallback if build output is just in dist/professional-viewport-ui
            cp -r "$PWD_DIST"/* "$PUB/"
          fi
          # copy server files into a subfolder so you still have them available in the deployment bundle
          if [ -d "$PWD_DIST/server" ]; then
            mkdir -p "$PUB/server"
            cp -r "$PWD_DIST/server"/* "$PUB/server/"
          fi

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
          directory: ./dist_publish
